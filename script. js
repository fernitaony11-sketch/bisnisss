// State Management
let products = JSON.parse(localStorage.getItem('batikProducts')) || [];
let cart = JSON.parse(localStorage.getItem('batikCart')) || [];
let currentUser = JSON.parse(localStorage.getItem('batikUser')) || null;

// DOM Elements
const sections = document.querySelectorAll('.section');
const productsGrid = document.getElementById('products-grid');
const cartItems = document.getElementById('cart-items');
const cartCount = document.getElementById('cart-count');
const authLinks = document.getElementById('auth-links');
const logoutLink = document.getElementById('logout-link');
const userWelcome = document.getElementById('user-welcome');

// Init
document.addEventListener('DOMContentLoaded', () => {
    renderProducts();
    updateCartUI();
    if (currentUser) {
        showUserUI();
        loadProducts();
    }
});

// Section Navigation
function showSection(sectionId) {
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    if (sectionId === 'upload' && !currentUser) showLogin();
}

// Modal Controls
function showLogin() { document.getElementById('login-modal').style.display = 'block'; }
function showRegister() { document.getElementById('register-modal').style.display = 'block'; }
function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

// Auth Functions
function login() {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    if (email && pass) {
        currentUser = { email, name: email.split('@')[0] };
        localStorage.setItem('batikUser', JSON.stringify(currentUser));
        showUserUI();
        closeModal('login-modal');
        alert('Login berhasil!');
    }
}

function register() {
    const name = document.getElementById('reg-name').value;
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;
    if (name && email && pass) {
        currentUser = { name, email };
        localStorage.setItem('batikUser', JSON.stringify(currentUser));
        showUserUI();
        closeModal('register-modal');
        alert('Registrasi berhasil!');
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('batikUser');
    authLinks.style.display = 'block';
    logoutLink.style.display = 'none';
    userWelcome.style.display = 'none';
    alert('Logout berhasil!');
}

function showUserUI() {
    authLinks.style.display = 'none';
    logoutLink.style.display = 'block';
    userWelcome.textContent = `Halo, ${currentUser.name}!`;
    userWelcome.style.display = 'inline';
}

// Upload Produk
document.getElementById('upload-form').addEventListener('submit', (e) => {
    e.preventDefault();
    if (!currentUser) return showLogin();
    
    const formData = new FormData(e.target);
    const name = document.getElementById('product-name').value;
    const price = document.getElementById('product-price').value;
    const desc = document.getElementById('product-desc').value;
    const imageFile = document.getElementById('product-image').files[0];
    
    if (name && price && imageFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const product = {
                id: Date.now(),
                name, price: parseInt(price), desc,
                image: e.target.result,
                uploadedBy: currentUser.email
            };
            products.unshift(product);
            localStorage.setItem('batikProducts', JSON.stringify(products));
            renderProducts();
            e.target.reset();
            document.getElementById('image-preview').innerHTML = '';
            alert('Produk berhasil diupload!');
        };
        reader.readAsDataURL(imageFile);
    }
});

// Image Preview
document.getElementById('product-image').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('image-preview').innerHTML = `<img src="${ev.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
    }
});

// Products Rendering
function renderProducts(filteredProducts = products) {
    productsGrid.innerHTML = filteredProducts.map(p => `
        <div class="product-card">
            <img src="${p.image}" alt="${p.name}">
            <div class="product-info">
                <h3>${p.name}</h3>
                <p>Rp ${p.price.toLocaleString()}</p>
                <p>${p.desc}</p>
                <button class="add-to-cart" onclick="addToCart(${p.id})">ðŸ›’ Tambah Keranjang</button>
            </div>
        </div>
    `).join('');
}

function searchProducts() {
    const query = document.getElementById('search-input').value.toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(query) || p.desc.toLowerCase().includes(query));
    renderProducts(filtered);
}

// Cart Functions
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    const cartItem = cart.find(item => item.id === productId);
    if (cartItem) {
        cartItem.quantity += 1;
    } else {
        cart.push({ ...product, quantity: 1 });
    }
    localStorage.setItem('batikCart', JSON.stringify(cart));
    updateCartUI();
    alert('Ditambahkan ke keranjang!');
}

function updateCartUI() {
    cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartItems.innerHTML = cart.map(item => `
        <div>${item.name} x${item.quantity} - Rp ${(item.price * item.quantity).toLocaleString()}</div>
    `).join('') || '<p>Keranjang kosong</p>';
}

function checkout() {
    if (cart.length === 0) return alert('Keranjang kosong!');
    if (!currentUser) return showLogin();
    alert(`Checkout berhasil! Total: Rp ${cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString()}`);
    cart = [];
    localStorage.setItem('batikCart', JSON.stringify(cart));
    updateCartUI();
}

// Dark Mode
function toggleDarkMode() {
    document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}

if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');
